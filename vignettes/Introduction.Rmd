---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r options, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Set up

Load required packages.

```{r setup, message = FALSE}
library(HerringData)
library(SpawnIndex)
library(tidyverse)
library(DBI)
```

Load required data.

```{r data}
data(pars)
data(codes_group)
data(conv_factors)
data(database_info)
```

# Data

The following process for the three data types is similar.
First, load the data and wrangle it into a user-friendly format
via the respective function in the `loaders` family.
Then, filter to the Prince Rupert District (PRD) stock assessment region (SAR).
Finally, aggregate and wrangle the data to use in SISCAH
via the respective function in the `SISCAH` family.

## Biological data

First, load and wrangle biological data: number- and weight-at-age.
Then, filter to only include data from the PRD SAR.
Finally, aggregate the data by year, gear, and stock to input into SISCAH.
Note that the `structure` argument (set to Statistical Area in this example)
indicates the implied sub-stock structure.

```{r bio}
bio <- load_bio(db_info = database_info, quiet = TRUE) %>%
  filter(Region == "PRD") %>%
  siscah_bio(structure = "StatArea")
```

Number-at-age by stock, gear, and year for fish aged
`r formals(siscah_bio)$age_min_number`
(i.e., column 'a`r formals(siscah_bio)$age_min_number`') to
`r formals(siscah_bio)$age_max`.
The 'Stock' column is the sub-stock name
and indicates the Statistical Area number (e.g., "StatArea03").
The 'Area' column is a number that increments from 1
to the number of sub-stocks.
<!-- TODO: What is period? -->
The 'Gear' column indicates the period (see XXX).

```{r bio_num}
bio$number_age
```

Weight-at-age in kilograms for fish aged
`r formals(siscah_bio)$age_min_weight` to
`r formals(siscah_bio)$age_max`.
Note that table layout is similar to the number-at-age table.
There are two weight-at-age tables:
weight-at-age by year, gear, and stock, as well as
weight-at-age by year and stock for seine gear only.

```{r bio_wt}
bio$weight_age
bio$weight_age_seine
```

## Catch data

Like biological data above,
load and wrangle catch data,
filter to only include data from the PRD SAR, and
aggregate the data by year, gear, and stock to input into SISCAH.

```{r catch}
catch <- load_catch(db_info = database_info, quiet = TRUE) %>%
  filter(Region == "PRD") %>%
  siscah_catch(structure = "StatArea")
```

Catch by stock, gear, and year in thousands of tonnes.
Note that table layout is similar to the biological data tables.

```{r catch_catch}
catch
```

## Spawn data

Like biological and catch data above,
load and wrangle spawn index data,
filter to only include data from the PRD SAR, and
aggregate the data by year and stock to input into SISCAH.
Note that the spawn index is calculated when the data is loaded
using functions in the `SpawnIndex` package.
For SISCAH, there are two types of spawn index data:
data from surface surveys and data from dive surveys.

```{r spawn}
spawn <- load_spawn(db_info = database_info, quiet = TRUE) %>%
  filter(Region == "PRD") %>%
  siscah_spawn(structure = "StatArea")
```

Spawn index by stock and year in thousands of tonnes.
Note that table layout is similar to the biological and catch data tables.

```{r spawn_spawn}
spawn
```

# Figures

Example figures to display biological, catch, and spawn data.

## Biological data

<!-- TODO: Plots -->

```{r bio_plot}
# ggplot(data = bio, mapping = aes(x = ))
```

## Catch data

Plot annual catch data for each stock and period.

```{r catch_plot, fig.width = 8, fig.height = 5}
catch_dat <- catch %>%
    mutate(Period = as.character(Gear))
catch_plot <- ggplot(
  data = catch_dat, mapping = aes(x = Year, y = Catch, fill = Period)
) +
  geom_col() +
  scale_fill_viridis_d() +
  labs(y = "Catch (1,000 t)") +
  facet_grid(Stock ~ ., scales = "free_y") +
  theme_bw() +
  theme(legend.position = "top")
catch_plot
```

## Spawn data

Plot annual spawn index data for each stock and survey type.

```{r spawn_plot, fig.width = 8, fig.height = 5}
spawn_dat <- spawn %>%
    pivot_longer(
      cols = c(Surface, Dive), names_to = "Survey", values_to = "Spawn"
    )
spawn_plot <- ggplot(
  data = spawn_dat, mapping = aes(x = Year, y = Spawn, fill = Survey)
) +
  geom_col() +
  scale_fill_viridis_d() +
  labs(y = "Spawn index (1,000 t)") +
  facet_grid(Stock ~ ., scales = "free_y") +
  theme_bw() +
  theme(legend.position = "top")
spawn_plot
```
